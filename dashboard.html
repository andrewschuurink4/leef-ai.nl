<!DOCTYPE html>
<html lang="nl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leef - Jouw AI Levenscoach</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
            color: #4a4a4a;
        }
        .main-accent-color { color: #5D8B71; }
        .main-accent-bg { background-color: #5D8B71; }
        .secondary-accent-bg { background-color: #EAE7DC; }
        .task-item.completed label span.task-text, .shopping-item.completed span {
            text-decoration: line-through;
            color: #a0aec0;
        }
        #modal-container, #modal-box { transition: opacity 0.3s ease, transform 0.3s ease; }
        .ai-checklist { border-left: 3px solid #B0D4B8; background-color: #fafffa; }
        #voice-control-btn { box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1); transition: all 0.3s ease-in-out; }
        #voice-control-btn.listening { background-color: #ef4444; transform: scale(1.1); }
        #parking-assist-toggle-btn.active { background-color: #ef4444; color: white; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Layout Container -->
    <div class="flex">
        <!-- Desktop Sidebar Navigation -->
        <nav class="hidden md:flex flex-col items-center w-20 bg-white shadow-md min-h-screen fixed top-0 left-0 z-40">
            <div class="py-5 main-accent-color"><i class="fa-solid fa-leaf fa-2x"></i></div>
            <ul id="desktop-nav-list" class="flex flex-col space-y-2 mt-8">
                <!-- Nav items worden hier dynamisch ingevoegd door JS -->
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="w-full md:pl-20 pb-24 md:pb-0">
            <div class="p-4 md:p-8 max-w-7xl mx-auto">
                <header class="mb-6"><h1 class="text-4xl font-bold text-gray-800">Leef</h1><p class="text-lg text-gray-500">Jouw persoonlijke AI levenscoach. Welkom terug!</p></header>
                
                <section id="module-dagelijks" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-house main-accent-color mr-3"></i>Dagelijks Leven</h2>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm">
                            <h3 class="font-bold text-xl mb-4">Mijn Taken Voor Vandaag</h3>
                            <div id="task-list" class="space-y-3 mb-4"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-task-input" placeholder="Nieuwe taak..." class="flex-grow p-3 border rounded-lg">
                                <button id="ai-subtask-btn" title="AI, help met subtaken" class="secondary-accent-bg font-bold p-3 rounded-lg hover:opacity-90"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                                <button id="add-task-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Voeg toe</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm">
                            <h3 class="font-bold text-xl mb-4">Boodschappenlijst</h3>
                            <div id="shopping-list" class="space-y-3 mb-4"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-shopping-item-input" placeholder="bv. Melk, Brood..." class="flex-grow p-3 border rounded-lg">
                                <button id="add-shopping-item-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Voeg toe</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm">
                            <h3 class="font-bold text-xl mb-4">Nieuwe Afspraak Toevoegen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input id="new-appointment-title" type="text" placeholder="Titel van afspraak" class="p-3 border rounded-lg"><input id="new-appointment-datetime" type="datetime-local" class="p-3 border rounded-lg text-gray-500"></div>
                            <textarea id="new-appointment-desc" placeholder="Beschrijving (optioneel, helpt de AI)" class="w-full p-3 border rounded-lg mb-4" rows="2"></textarea>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="add-appointment-btn" class="w-full sm:w-auto main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90 flex-grow">Voeg toe</button>
                                <button id="ai-prepare-btn" class="w-full sm:w-auto secondary-accent-bg font-bold p-3 rounded-lg hover:opacity-90 flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> AI, help voorbereiden!</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="module-gezondheid" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-heart-pulse main-accent-color mr-3"></i>Gezondheid & Welzijn</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm space-y-8">
                        <div>
                            <h4 class="font-bold text-lg mt-6 mb-2">Wekker & Dagvoorbereiding</h4>
                            <p class="text-sm text-gray-600">Word wakker met een overzicht van je dag.</p>
                            <div class="flex items-center gap-4 mt-4">
                                <input type="time" id="alarm-time-input" class="p-2 border rounded-lg">
                                <button id="set-alarm-btn" class="main-accent-bg text-white font-bold py-2 px-4 rounded-lg">Stel in</button>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Wekker staat op <strong id="alarm-time-display">niet ingesteld</strong>.</p>
                        </div>
                        <hr>
                        <div>
                             <h4 class="font-bold text-lg mt-6 mb-2">AI Sportcoach</h4>
                            <p class="text-sm text-gray-600 mb-4">Vraag de AI om een workout op maat.</p>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input id="sport-prompt-input" type="text" placeholder="bv. '30 min cardio thuis'" class="flex-grow p-3 border rounded-lg">
                                <button id="get-sport-tips-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Krijg Workout</button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="module-herinneringen" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-bell main-accent-color mr-3"></i>Contextuele Herinneringen</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm"><h4 class="font-bold text-lg mb-2">Huis Verlaten</h4><p class="text-sm text-gray-600 mb-4">Ontvang een 'vergeet-niet' lijst.</p><div class="flex items-center justify-between mt-6"><span class="font-bold">Actief</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:main-accent-bg"></div></label></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm"><h4 class="font-bold text-lg mb-2">Bij Supermarkt</h4><p class="text-sm text-gray-600 mb-4">Toon boodschappenlijst bij aankomst.</p><div class="flex items-center justify-between mt-6"><span class="font-bold">Actief</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:main-accent-bg"></div></label></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm">
                            <h4 class="font-bold text-lg mb-2">Automatische Parkeerassistent</h4>
                            <p class="text-sm text-gray-600 mb-4">Detecteert parkeren en wegrijden.</p>
                            <button id="parking-assist-toggle-btn" class="w-full secondary-accent-bg font-bold py-2 px-4 rounded-lg hover:opacity-90 mt-6">Start Parkeerassistent</button>
                            <div id="parking-status-container" class="hidden mt-4 text-center">
                                <p class="font-bold text-lg main-accent-color">Geparkeerd</p>
                                <p class="text-2xl font-mono" id="parking-timer-display">00:00:00</p>
                                <a href="#" id="parking-location-link" target="_blank" class="text-sm text-blue-600 hover:underline">Toon op kaart</a>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="module-financien" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-wallet main-accent-color mr-3"></i>Financiën & Administratie</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm">
                            <h4 class="font-bold text-lg mb-2">Maandbudget</h4>
                            <div class="mx-auto" style="position: relative; height:200px; width:200px"><canvas id="budgetChart"></canvas></div>
                            <div class="text-center mt-4"><p class="text-sm text-gray-500">Uitgegeven</p><p class="text-2xl font-bold" id="spent-amount">€0</p><p class="text-sm text-gray-500">van <span id="total-budget" class="font-bold">€0</span></p></div>
                            <hr class="my-4"><h5 class="font-bold text-md mb-2">Stel budget in (€)</h5>
                            <div class="flex gap-2"><input type="number" id="budget-input" placeholder="bv. 2000" class="w-full p-2 border rounded-lg"><button id="update-budget-btn" class="main-accent-bg text-white font-bold p-2 rounded-lg">OK</button></div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm">
                            <h4 class="font-bold text-lg mb-2">Recente Uitgaven</h4>
                            <div id="expense-list" class="space-y-2 max-h-48 overflow-y-auto mb-4 border-b pb-4"><p class="text-gray-500">Nog geen uitgaven toegevoegd.</p></div>
                            <h5 class="font-bold text-md mb-2">Voeg uitgave toe</h5>
                            <div class="flex flex-col sm:flex-row gap-2 mb-6"><input type="text" id="expense-desc-input" placeholder="Omschrijving" class="flex-grow p-2 border rounded-lg"><input type="number" id="expense-amount-input" placeholder="Bedrag €" class="w-full sm:w-32 p-2 border rounded-lg"><button id="add-expense-btn" class="main-accent-bg text-white font-bold p-2 rounded-lg">Voeg toe</button></div>
                            <hr class="my-4"><h4 class="font-bold text-lg mb-2">AI Financieel Advies</h4><p class="text-sm text-gray-600 mb-4">Krijg tips op basis van je uitgaven.</p><button id="ai-finance-tips-btn" class="font-bold py-2 px-4 rounded-lg secondary-accent-bg hover:opacity-90">Vraag AI om advies</button>
                        </div>
                    </div>
                </section>

                <section id="module-onderhoud" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-car-side main-accent-color mr-3"></i>Huis, Tuin & Auto</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-xl mb-4">AI Onderhouds- & Schoonmaaktips</h3>
                        <p class="text-sm text-gray-600 mb-4">Vraag de AI om een checklist voor elke klus.</p>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="maintenance-prompt-input" type="text" placeholder="bv. 'auto wassen' of 'badkamer schoonmaken'" class="flex-grow p-3 border rounded-lg">
                            <button id="get-maintenance-tips-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Krijg Checklist</button>
                        </div>
                    </div>
                </section>

                <section id="module-werk" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-briefcase main-accent-color mr-3"></i>Werk & Carrière</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-xl mb-4">AI Carrièrecoach</h3>
                        <p class="text-sm text-gray-600 mb-4">Bereid je voor op je volgende carrièrestap.</p>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="career-prompt-input" type="text" placeholder="bv. 'sollicitatiegesprek voor project manager'" class="flex-grow p-3 border rounded-lg">
                            <button id="get-career-tips-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Krijg Coaching</button>
                        </div>
                    </div>
                </section>

                <section id="module-vrijetijd" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-martini-glass-citrus main-accent-color mr-3"></i>Vrije Tijd & Sociaal Leven</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-xl mb-4">AI Vrijetijdsplanner</h3>
                        <p class="text-sm text-gray-600 mb-4">Vind de perfecte activiteit, reis of date night.</p>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="leisure-prompt-input" type="text" placeholder="bv. 'weekendje weg in de natuur' of 'leuke date night thuis'" class="flex-grow p-3 border rounded-lg">
                            <button id="get-leisure-tips-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Krijg Ideeën</button>
                        </div>
                    </div>
                </section>

                <section id="module-ontwikkeling" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-lightbulb main-accent-color mr-3"></i>Persoonlijke Ontwikkeling</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-xl mb-4">AI Leerassistent</h3>
                        <p class="text-sm text-gray-600 mb-4">Leer een nieuwe vaardigheid met een stappenplan van de AI.</p>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="learning-prompt-input" type="text" placeholder="bv. 'leer gitaar spelen' of 'beginnen met beleggen'" class="flex-grow p-3 border rounded-lg">
                            <button id="get-learning-plan-btn" class="main-accent-bg text-white font-bold p-3 rounded-lg hover:opacity-90">Maak Leerplan</button>
                        </div>
                    </div>
                </section>

                <section id="module-instellingen" class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4"><i class="fa-solid fa-sliders main-accent-color mr-3"></i>Instellingen</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-xl mb-4">Toon/Verberg Modules</h3>
                        <p class="text-sm text-gray-600 mb-4">Kies welke onderdelen je wilt gebruiken in de app.</p>
                        <div id="module-toggle-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- Toggles worden hier dynamisch ingevoegd -->
                        </div>
                    </div>
                </section>

            </div>
        </main>

        <!-- Voice Control Button -->
        <button id="voice-control-btn" class="fixed bottom-24 md:bottom-6 right-6 h-16 w-16 main-accent-bg text-white rounded-full flex items-center justify-center z-50">
            <i class="fa-solid fa-microphone fa-2x"></i>
        </button>

        <!-- Mobile Bottom Navigation -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-t-lg z-40">
            <ul id="mobile-nav-list" class="flex justify-around items-center h-20">
                <!-- Nav items worden hier dynamisch ingevoegd -->
            </ul>
        </nav>

        <!-- Modal -->
        <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
            <div id="modal-box" class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
                <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
                <div id="modal-content" class="text-gray-600 max-h-[60vh] overflow-y-auto"></div>
                <button id="modal-close-btn" class="mt-6 w-full main-accent-bg text-white font-bold py-2 px-4 rounded-lg">Sluiten</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- CONFIGURATIE ---
    const modules = [
        { id: 'dagelijks', name: 'Dagelijks', icon: 'fa-house' },
        { id: 'gezondheid', name: 'Gezondheid', icon: 'fa-heart-pulse' },
        { id: 'herinneringen', name: 'Herinneringen', icon: 'fa-bell' },
        { id: 'financien', name: 'Financiën', icon: 'fa-wallet' },
        { id: 'onderhoud', name: 'Onderhoud', icon: 'fa-car-side' },
        { id: 'werk', name: 'Werk', icon: 'fa-briefcase' },
        { id: 'vrijetijd', name: 'Vrije Tijd', icon: 'fa-martini-glass-citrus' },
        { id: 'ontwikkeling', name: 'Ontwikkeling', icon: 'fa-lightbulb' },
        { id: 'instellingen', name: 'Instellingen', icon: 'fa-sliders' }
    ];

    const state = {
        moduleSettings: {},
        tasks: [],
        shoppingList: [],
        appointments: [],
        budget: 0,
        expenses: [],
        alarmTime: null,
        alarmCheckInterval: null,
        isParked: false,
        parkingLocation: null,
        parkingStartTime: null,
        parkingTimerInterval: null,
        gpsWatchId: null,
        stillTimer: null,
        isListening: false,
    };

    let budgetChartInstance = null;
    const ui = {
        desktopNavList: document.getElementById('desktop-nav-list'),
        mobileNavList: document.getElementById('mobile-nav-list'),
        moduleToggleContainer: document.getElementById('module-toggle-container'),
        modalContainer: document.getElementById('modal-container'),
        modalBox: document.getElementById('modal-box'),
        modalTitle: document.getElementById('modal-title'),
        modalContent: document.getElementById('modal-content'),
        modalCloseBtn: document.getElementById('modal-close-btn'),
        taskList: document.getElementById('task-list'),
        newTaskInput: document.getElementById('new-task-input'),
        addTaskBtn: document.getElementById('add-task-btn'),
        shoppingList: document.getElementById('shopping-list'),
        newShoppingItemInput: document.getElementById('new-shopping-item-input'),
        addShoppingItemBtn: document.getElementById('add-shopping-item-btn'),
        newAppointmentTitle: document.getElementById('new-appointment-title'),
        newAppointmentDatetime: document.getElementById('new-appointment-datetime'),
        newAppointmentDesc: document.getElementById('new-appointment-desc'),
        addAppointmentBtn: document.getElementById('add-appointment-btn'),
        budgetChart: document.getElementById('budgetChart'),
        spentAmount: document.getElementById('spent-amount'),
        totalBudget: document.getElementById('total-budget'),
        budgetInput: document.getElementById('budget-input'),
        updateBudgetBtn: document.getElementById('update-budget-btn'),
        expenseList: document.getElementById('expense-list'),
        expenseDescInput: document.getElementById('expense-desc-input'),
        expenseAmountInput: document.getElementById('expense-amount-input'),
        addExpenseBtn: document.getElementById('add-expense-btn'),
        parkingAssistToggleBtn: document.getElementById('parking-assist-toggle-btn'),
        parkingStatusContainer: document.getElementById('parking-status-container'),
        parkingTimerDisplay: document.getElementById('parking-timer-display'),
        parkingLocationLink: document.getElementById('parking-location-link'),
        alarmTimeInput: document.getElementById('alarm-time-input'),
        setAlarmBtn: document.getElementById('set-alarm-btn'),
        alarmTimeDisplay: document.getElementById('alarm-time-display'),
        voiceControlBtn: document.getElementById('voice-control-btn'),
    };

    // --- UTILITY & CORE FUNCTIONS ---
    function showModal(title, content) {
        ui.modalTitle.textContent = title;
        ui.modalContent.innerHTML = content;
        ui.modalContainer.classList.remove('hidden');
        setTimeout(() => ui.modalBox.classList.remove('scale-95', 'opacity-0'), 10);
    }
    function hideModal() {
        ui.modalBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => ui.modalContainer.classList.add('hidden'), 300);
    }
    
    // --- MODULE MANAGEMENT ---
    function saveModuleSettings() { localStorage.setItem('leef_module_settings', JSON.stringify(state.moduleSettings)); }
    function loadModuleSettings() {
        const savedSettings = JSON.parse(localStorage.getItem('leef_module_settings'));
        if (savedSettings) { state.moduleSettings = savedSettings; } 
        else { modules.forEach(m => state.moduleSettings[m.id] = true); }
    }
    function applyModuleSettings() {
        modules.forEach(m => {
            const section = document.getElementById(`module-${m.id}`);
            if (section) {
                section.style.display = state.moduleSettings[m.id] ? '' : 'none';
            }
        });
        renderNavigation();
    }
    function renderNavigation() {
        ui.desktopNavList.innerHTML = '';
        ui.mobileNavList.innerHTML = '';
        modules.filter(m => state.moduleSettings[m.id]).forEach(m => {
            const navItemHTML = `<li><a href="#module-${m.id}" title="${m.name}" class="nav-link flex flex-col items-center justify-center h-16 w-16 rounded-xl hover:secondary-accent-bg"><i class="fa-solid ${m.icon} fa-lg"></i><span class="text-xs mt-1">${m.name}</span></a></li>`;
            ui.desktopNavList.innerHTML += navItemHTML;
            ui.mobileNavList.innerHTML += navItemHTML;
        });
    }
    function renderModuleToggles() {
        ui.moduleToggleContainer.innerHTML = '';
        modules.forEach(m => {
            if (m.id === 'instellingen') return;
            const isChecked = state.moduleSettings[m.id];
            const toggleHTML = `<label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" data-module-id="${m.id}" class="module-toggle h-5 w-5 rounded text-green-600 focus:ring-green-500 border-gray-300" ${isChecked ? 'checked' : ''}><span>${m.name}</span></label>`;
            ui.moduleToggleContainer.innerHTML += toggleHTML;
        });
        document.querySelectorAll('.module-toggle').forEach(toggle => {
            toggle.addEventListener('change', (e) => {
                state.moduleSettings[e.target.dataset.moduleId] = e.target.checked;
                saveModuleSettings();
                applyModuleSettings();
            });
        });
    }
    
    // --- STATE MANAGEMENT ---
    function saveState() {
        const stateToSave = { ...state };
        delete stateToSave.moduleSettings; // Sla module settings apart op
        localStorage.setItem('leef_app_state', JSON.stringify(stateToSave));
    }
    function loadState() {
        const savedState = JSON.parse(localStorage.getItem('leef_app_state'));
        if (savedState) { 
            Object.assign(state, savedState);
        }
    }

    // --- AI PLACEHOLDER ---
    async function getAiResponse(prompt, placeholder, title = "AI Suggestie") {
        console.log("AI Prompt:", prompt);
        showModal("AI denkt na...", '<div class="flex justify-center p-4"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>');
        await new Promise(resolve => setTimeout(resolve, 1500));
        hideModal();
        setTimeout(() => showModal(title, placeholder), 350);
    }

    // --- RENDER FUNCTIONS ---
    function renderAll() {
        renderTasks();
        renderShoppingList();
        renderAppointments();
        renderBudgetChart();
        renderExpenses();
        renderAlarmTime();
        renderParkingStatus();
    }
    
    // --- DAGELIJKS LEVEN FUNCTIONS ---
    function renderTasks() {
        ui.taskList.innerHTML = state.tasks.length ? '' : '<p class="text-gray-500">Geen taken voor vandaag.</p>';
        state.tasks.forEach(task => {
            const taskEl = document.createElement('div');
            taskEl.className = `task-item flex items-center justify-between p-2 rounded-lg ${task.completed ? 'completed' : ''}`;
            taskEl.innerHTML = `<label class="flex items-center cursor-pointer"><input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" class="mr-3 h-5 w-5 rounded text-green-600 focus:ring-green-500 border-gray-300"><span class="task-text">${task.text}</span></label><button onclick="deleteTask(${task.id})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`;
            ui.taskList.appendChild(taskEl);
        });
    }
    function addTask() {
        const text = ui.newTaskInput.value.trim();
        if(text) {
            state.tasks.push({ id: Date.now(), text, completed: false });
            saveState();
            renderTasks();
            ui.newTaskInput.value = '';
        }
    }
    window.toggleTask = (id) => {
        const task = state.tasks.find(t => t.id === id);
        if(task) { task.completed = !task.completed; saveState(); renderTasks(); }
    };
    window.deleteTask = (id) => {
        state.tasks = state.tasks.filter(t => t.id !== id);
        saveState();
        renderTasks();
    };

    function renderShoppingList() {
        ui.shoppingList.innerHTML = state.shoppingList.length ? '' : '<p class="text-gray-500">Boodschappenlijst is leeg.</p>';
        state.shoppingList.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = `shopping-item flex items-center justify-between p-2 rounded-lg ${item.completed ? 'completed' : ''}`;
            itemEl.innerHTML = `<label class="flex items-center cursor-pointer"><input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleShoppingItem(${item.id})" class="mr-3 h-5 w-5 rounded text-green-600 focus:ring-green-500 border-gray-300"><span>${item.text}</span></label><button onclick="deleteShoppingItem(${item.id})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`;
            ui.shoppingList.appendChild(itemEl);
        });
    }
    function addShoppingItem() {
        const text = ui.newShoppingItemInput.value.trim();
        if(text) {
            state.shoppingList.push({ id: Date.now(), text, completed: false });
            saveState();
            renderShoppingList();
            ui.newShoppingItemInput.value = '';
        }
    }
    window.toggleShoppingItem = (id) => {
        const item = state.shoppingList.find(i => i.id === id);
        if(item) { item.completed = !item.completed; saveState(); renderShoppingList(); }
    };
    window.deleteShoppingItem = (id) => {
        state.shoppingList = state.shoppingList.filter(i => i.id !== id);
        saveState();
        renderShoppingList();
    };

    function renderAppointments() { /* ... implementatie ... */ }
    function addAppointment() { /* ... implementatie ... */ }

    // --- FINANCIËN FUNCTIONS ---
    function renderBudgetChart() {
        const spent = state.expenses.reduce((sum, e) => sum + e.amount, 0);
        const remaining = state.budget - spent;
        if (budgetChartInstance) { budgetChartInstance.destroy(); }
        const budgetCanvas = ui.budgetChart.getContext('2d');
        budgetChartInstance = new Chart(budgetCanvas, {
            type: 'doughnut',
            data: {
                labels: ['Uitgegeven', 'Resterend'],
                datasets: [{
                    data: [spent > 0 ? spent : 0, remaining > 0 ? remaining : 0.01],
                    backgroundColor: ['#ef4444', '#5D8B71'],
                    borderColor: '#F8F7F4',
                    borderWidth: 4
                }]
            },
            options: { responsive: true, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: true } } }
        });
        ui.spentAmount.textContent = `€${spent.toFixed(2)}`;
        ui.totalBudget.textContent = `€${state.budget.toFixed(2)}`;
    }
    function updateBudget() {
        const newBudget = parseFloat(ui.budgetInput.value);
        if (!isNaN(newBudget) && newBudget >= 0) {
            state.budget = newBudget;
            saveState();
            renderBudgetChart();
        }
    }
    function renderExpenses() {
        ui.expenseList.innerHTML = state.expenses.length ? '' : '<p class="text-gray-500">Nog geen uitgaven toegevoegd.</p>';
        state.expenses.slice().reverse().forEach(expense => {
            const expenseEl = document.createElement('div');
            expenseEl.className = 'flex justify-between items-center text-sm';
            expenseEl.innerHTML = `<span>${expense.desc}</span><span class="font-bold">€${expense.amount.toFixed(2)}</span>`;
            ui.expenseList.appendChild(expenseEl);
        });
    }
    function addExpense() {
        const desc = ui.expenseDescInput.value.trim();
        const amount = parseFloat(ui.expenseAmountInput.value);
        if (desc && !isNaN(amount) && amount > 0) {
            state.expenses.push({ id: Date.now(), desc, amount });
            saveState();
            renderExpenses();
            renderBudgetChart();
            ui.expenseDescInput.value = '';
            ui.expenseAmountInput.value = '';
        } else {
            showModal('Fout', 'Vul een geldige omschrijving en bedrag in.');
        }
    }

    // --- PARKEER & WEKKER FUNCTIES ---
    function setAlarm() {
        const time = ui.alarmTimeInput.value;
        if (time) {
            state.alarmTime = time;
            saveState();
            renderAlarmTime();
            showModal('Wekker Ingesteld', `De wekker staat nu op ${time}.`);
        }
    }
    function renderAlarmTime() { ui.alarmTimeDisplay.textContent = state.alarmTime || 'niet ingesteld'; }
    function checkAlarm() {
        if (!state.alarmTime) return;
        const now = new Date();
        const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        if (currentTime === state.alarmTime) {
            triggerAlarm();
            state.alarmTime = null; 
            saveState();
            renderAlarmTime();
        }
    }
    async function triggerAlarm() {
        const placeholder = `Een frisse start! <strong>Tip:</strong> Begin met de belangrijkste taak. Maak er een geweldige dag van!`;
        await getAiResponse("Genereer een 'goedemorgen' bericht met een dagoverzicht en tip.", placeholder, "Goedemorgen!");
    }
    
    function toggleParkingAssistant() {
        state.isParkingAssistantActive = !state.isParkingAssistantActive;
        if (state.isParkingAssistantActive) {
            startGpsTracking();
            ui.parkingAssistToggleBtn.classList.add('active');
            ui.parkingAssistToggleBtn.textContent = 'Stop Parkeerassistent';
        } else {
            stopGpsTracking();
            ui.parkingAssistToggleBtn.classList.remove('active');
            ui.parkingAssistToggleBtn.textContent = 'Start Parkeerassistent';
        }
    }
    function startGpsTracking() {
        if (!navigator.geolocation) return showModal('Fout', 'Geolocatie wordt niet ondersteund.');
        showModal('Info', 'Parkeerassistent is gestart.');
        state.gpsWatchId = navigator.geolocation.watchPosition(handlePositionUpdate, () => showModal('GPS Fout', 'Kon locatie niet ophalen.'), { enableHighAccuracy: true });
    }
    function stopGpsTracking() {
        if (state.gpsWatchId) navigator.geolocation.clearWatch(state.gpsWatchId);
        if (state.stillTimer) clearTimeout(state.stillTimer);
    }
    function handlePositionUpdate(position) {
        const { latitude, longitude, speed } = position.coords;
        const currentSpeed = speed || 0;
        if (currentSpeed < 1 && !state.isParked) {
            if (!state.stillTimer) {
                state.stillTimer = setTimeout(() => markAsParked(latitude, longitude), 15000);
            }
        } else if (currentSpeed > 2 && state.isParked) {
            markAsDriving();
        }
        if (state.stillTimer && currentSpeed > 1) {
            clearTimeout(state.stillTimer);
            state.stillTimer = null;
        }
    }
    function markAsParked(lat, lon) {
        state.isParked = true;
        state.parkingLocation = { lat, lon };
        state.parkingStartTime = new Date().toISOString();
        saveState();
        renderParkingStatus();
        state.parkingTimerInterval = setInterval(renderParkingStatus, 1000);
    }
    function markAsDriving() {
        if (state.parkingTimerInterval) clearInterval(state.parkingTimerInterval);
        state.isParked = false;
        state.parkingStartTime = null;
        saveState();
        renderParkingStatus();
        showModal('Info', 'Goede reis! Parkeerassistent volgt opnieuw.');
    }
    function renderParkingStatus() {
        if (state.isParked && state.parkingStartTime) {
            const now = new Date();
            const elapsed = Math.floor((now - new Date(state.parkingStartTime)) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            ui.parkingTimerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            ui.parkingLocationLink.href = `https://maps.google.com/?q=${state.parkingLocation.lat},${state.parkingLocation.lon}`;
            ui.parkingStatusContainer.classList.remove('hidden');
        } else {
            ui.parkingStatusContainer.classList.add('hidden');
        }
    }

    // --- INITIALIZATION ---
    function initialize() {
        loadModuleSettings();
        loadState();
        applyModuleSettings();
        renderModuleToggles();
        renderAll();
        
        // Event Listeners
        ui.modalCloseBtn.addEventListener('click', hideModal);
        ui.addTaskBtn.addEventListener('click', addTask);
        ui.addShoppingItemBtn.addEventListener('click', addShoppingItem);
        ui.updateBudgetBtn.addEventListener('click', updateBudget);
        ui.addExpenseBtn.addEventListener('click', addExpense);
        ui.setAlarmBtn.addEventListener('click', setAlarm);
        ui.parkingAssistToggleBtn.addEventListener('click', toggleParkingAssistant);
        
        // AI Knop Event Listeners
        document.getElementById('ai-subtask-btn').addEventListener('click', () => {
             const query = ui.newTaskInput.value;
             if (!query) return showModal('Info', 'Voer een taak in.');
             const placeholder = `<h4 class="font-bold mb-2">Subtaken voor: ${query}</h4><ul class="list-disc list-inside text-left"><li>Subtaak 1</li><li>Subtaak 2</li><li>Subtaak 3</li></ul>`;
             getAiResponse(`Maak subtaken voor ${query}`, placeholder);
        });
        document.getElementById('get-maintenance-tips-btn').addEventListener('click', () => {
            const query = document.getElementById('maintenance-prompt-input').value;
            if (!query) return showModal('Info', 'Voer een klus in.');
            const placeholder = `<h4 class="font-bold mb-2">Checklist voor: ${query}</h4><ul class="list-disc list-inside text-left"><li>Stap 1: Benodigdheden verzamelen.</li><li>Stap 2: Werkplek voorbereiden.</li><li>Stap 3: Klus uitvoeren.</li><li>Stap 4: Opruimen.</li></ul>`;
            getAiResponse(`Maak een onderhoudsplan voor ${query}`, placeholder);
        });
        document.getElementById('get-career-tips-btn').addEventListener('click', () => {
            const query = document.getElementById('career-prompt-input').value;
            if (!query) return showModal('Info', 'Voer een carrièredoel in.');
            const placeholder = `<h4 class="font-bold mb-2">Voorbereiding voor: ${query}</h4><ul class="list-disc list-inside text-left"><li>Tip 1: Onderzoek het bedrijf grondig.</li><li>Tip 2: Bereid de STAR-methode voor.</li><li>Tip 3: Stel zelf ook 3 slimme vragen.</li></ul>`;
            getAiResponse(`Geef carrièreadvies voor ${query}`, placeholder);
        });
        document.getElementById('get-leisure-tips-btn').addEventListener('click', () => {
            const query = document.getElementById('leisure-prompt-input').value;
            if (!query) return showModal('Info', 'Voer een wens in.');
            const placeholder = `<h4 class="font-bold mb-2">Ideeën voor: ${query}</h4><ul class="list-disc list-inside text-left"><li>Optie 1: Bezoek een lokaal park.</li><li>Optie 2: Probeer een nieuw recept.</li><li>Optie 3: Organiseer een spelletjesavond.</li></ul>`;
            getAiResponse(`Geef vrijetijdsideeën voor ${query}`, placeholder);
        });
        document.getElementById('get-learning-plan-btn').addEventListener('click', () => {
            const query = document.getElementById('learning-prompt-input').value;
            if (!query) return showModal('Info', 'Voer een leerdoel in.');
            const placeholder = `<h4 class="font-bold mb-2">Leerplan voor: ${query}</h4><ol class="list-decimal list-inside text-left"><li>Week 1: Focus op de basisprincipes.</li><li>Week 2: Oefen 30 minuten per dag.</li><li>Week 3: Zoek een online community.</li><li>Week 4: Pas je kennis toe in een klein project.</li></ol>`;
            getAiResponse(`Maak een leerplan voor ${query}`, placeholder);
        });
        document.getElementById('get-sport-tips-btn').addEventListener('click', () => {
            const query = document.getElementById('sport-prompt-input').value;
            if (!query) return showModal('Info', 'Voer een sportdoel in.');
            const placeholder = `<h4 class="font-bold mb-2">Workout voor: ${query}</h4><ol class="list-decimal list-inside text-left"><li>Warming-up: 5 minuten joggen.</li><li>Oefening 1: 3x10 Push-ups.</li><li>Oefening 2: 3x15 Squats.</li><li>Cooling-down: 5 minuten stretchen.</li></ol>`;
            getAiResponse(`Maak een workout voor ${query}`, placeholder);
        });
         document.getElementById('ai-finance-tips-btn').addEventListener('click', () => {
            if (state.budget <= 0 || state.expenses.length === 0) {
                return showModal('Info', 'Stel eerst je budget in en voeg enkele uitgaven toe voor persoonlijk advies.');
            }
            const placeholder = `<h4 class="font-bold mb-2">Financiële Tips</h4><ul class="list-disc list-inside text-left"><li>Tip 1: Probeer vaker zelf te koken.</li><li>Tip 2: Bundel je abonnementen.</li><li>Tip 3: Stel een specifiek 'leuk-geld' budget in.</li></ul>`;
            getAiResponse(`Analyseer mijn uitgaven en geef bespaartips.`, placeholder);
        });

        // Start de wekker-checker
        state.alarmCheckInterval = setInterval(checkAlarm, 30000);
    }

    initialize();
});
</script>

</body>
</html>
